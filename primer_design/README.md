# Description

The R script [design_primers.R](design_primers) is used to design primers for the amplification of specific nuclear SNVs from 3' 10x scRNAseq cDNA libraries. For each mutation it generates outer, middle and staggered inner primers which can be used following the protocol described in our CloneTracer manuscript.

# Dependencies 

In order to run the script, samtools is required in the environment as well as the following R packages: tidyverse, GenomicRanges, GenomicFeatures, Seurat, BiocParallel, rtracklayer, BSgenome, TAPseq, ballgown, purrr, TxDb.Hsapiens.UCSC.hg38.knownGene, mygene, BSgenome.Hsapiens.UCSC.hg38.

We provide a conda environment with all dependencies installed:

```
git clone https://github.com/veltenlab/CloneTracer
cd primer_design
conda env create -f envs/primer_design.yml
```

# Primer design

## Input files

There are 3 main input files required to run the script:

* .csv file with the following format:

| symbol      | CHROM  | POS
| ----------- | ------ |-----------
| KRAS        | chr12  | 25245350
| NRAS        | chr1   | 114713909
| IDH2        | chr15  | 90088702

* BAM file from 3' 10x scRNAseq of the same sample
* [gtf file from ensembl](http://ftp.ensembl.org/pub/release-100/gtf/homo_sapiens/Homo_sapiens.GRCh38.100.chr.gtf.gz).

## Command-line execution

The script has the following command-line arguments:

### Required

* `-i, --input <filepath>`: input csv file with the format described above
* `-b --bam <filepath>`: bam file from 3' 10x genomics
* `-u --outdir_gene_exp <directory>`: outs directory generated by cellranger pipeline. It should include directory filtered_feature_bc_matrix used to create a Seurat object
* `-t --count_table <filepath>`: csv file with RNA count table with gene names as rows and cells as columns. First column should be named 'gene_names' and contain names of genes. Only required when cellranger output path is not provided (--outdir_gene_exp option)
* `-g --gtf_file <filepath>`: gtf file from ensembl
* `-n --name <text>`: sample name
* `-r --read_length <integer>`: read length of read2 
* `-d --out_directory <directory>`: directory where output files will be written

### Optional

* `-c --cores <integer>`: number of cores to use. 
* `-m --forced_mutations <filepath>`: text file with gene names (one per line) for which primers will be designed regardless of the expression of the gene or the distance of the mutation to the polyA.

### Run workflow

The following command would run the pipeline for P1 of the manuscript:

```
Rscript design_primers.R -i example_P1/input_variants.csv -b example_P1/genomic_files/subsetted.bam -u path/to/cellranger/outs -g path/to/gtf_file -n P1 -r 120 -d example_P1 -t TRUE -c 8 -m example_P1/muts.txt
```

# Output

The script produces 3 main output files:

```
*/primers/primer_sequence.csv
*/primers/primer_details.csv
*/primers/annotated_variants.csv
```

`primer_sequence.csv` contains the name of the primers as well as the sequence. 

`primer_details.csv` contains more detailed information about each primer (e.g. temperature of melting, distance from the mutation of interest...).

`annotated_variants.csv` includes information about the average expression of the mutated genes and estimated distance between mutations and the polyA tail. It further includes a column "primers" which indicates whether the mutation is suitable to be amplified. In case the mutation is not suitable for CloneTracer the column "reason" provides an explanation on why this is the case (see [Considerations section](#considerations) below):

| symbol      | CHROM  | POS       | counts_cell | distance_3_end | primers | reason            
| ----------- | ------ |-----------| ----------- | -------------- |-------- | ----------------
| KRAS        | chr12  | 25245350  | 0.56        | 282            | TRUE    | primers_designed
| IDH2        | chr1   | 114713909 | 1.06        | 1022           | TRUE    | primers_designed
| NRAS        | chr15  | 90088702  | 0.2         | 3808           | TRUE    | primers_designed

The script also generates several bed files stored in the `genomic_files` and `primers` directories which can be loaded into a genome browser to confirm the correct orientation and position of the primers. 

In our experience visualising these files is very helpful particularly in instances where the initial PCR reactions do not seem to work (e.g. no specific peak is found in bioanalyser traces).

# Considerations

There are 2 main limitations when it comes to genotyping nuclear SNVs from 3' scRNAseq: the expression of the gene and the distance of the mutation to the polyA tail (3' end of mRNA). From our experience, amplification of mutations in low-expressed genes is highly inefficient (only a small proportion of cells is covered). When it comes to mutations further away from the polyA tail, the main issue is the length of the resulting fragments. We have noticed that longer fragments (>1kb) are sequenced less efficiently than shorter ones in Illumina sequencers. Furthermore, amplifying very long fragments can be problematic when carrying out the nested PCRs.

By default we select mutations that are < 1.5kb away from the estimated polyA and in genes which are expressed in the sample of interest (mean raw counts/cell > 0.15). However if you would like to amplify variants which do not fullfill these requirements you can include the `-m --forced_mutations` flag with a txt file which includes the mutated gene names (one gene per line). The script will then generate primers for all mutations in these genes.  
